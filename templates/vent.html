<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Créer une Vente</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <h1>Créer une Vente</h1>

    <!-- Sélection du client -->
    <label for="client">Client :</label>
    <select id="client">
      {% for client in clients %}
      <option value="{{ client.id }}">
        {{ client.nom }} {{ client.prenom }}
      </option>
      {% endfor %}
    </select>

    <h3>Produits :</h3>
    <table border="1" id="products-table">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Prix Unitaire</th>
          <th>Quantité</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for produit in produits %}
        <tr>
          <td>
            {{ produit.nom }}
            <input type="hidden" value="{{ produit.id }}" class="produit-id" />
          </td>
          <td>
            {{ produit.prix }}
            <input
              type="hidden"
              value="{{ produit.prix }}"
              class="produit-prix"
            />
          </td>
          <td>
            <input type="number" min="1" value="1" class="quantite" />
          </td>
          <td>
            <button type="button" class="add-product">Ajouter</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3>Panier :</h3>
    <table border="1" id="cart-table">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Quantité</th>
          <th>Prix Total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les produits ajoutés apparaîtront ici -->
      </tbody>
    </table>

    <button id="submit-sale">Valider la Vente</button>

    <script>
      const cart = [];

      // Ajouter un produit au panier
      document.querySelectorAll(".add-product").forEach((button) => {
        button.addEventListener("click", (event) => {
          const row = event.target.closest("tr");
          const produitId = row.querySelector(".produit-id").value;
          const produitNom = row.querySelector("td:first-child").innerText;
          const prixUnitaire = row.querySelector(".produit-prix").value;
          const quantite = row.querySelector(".quantite").value;

          // Vérifier si le produit est déjà dans le panier
          const existing = cart.find((item) => item.produitId === produitId);
          if (existing) {
            existing.quantite =
              parseInt(existing.quantite) + parseInt(quantite);
          } else {
            cart.push({ produitId, produitNom, quantite, prixUnitaire });
          }

          updateCartTable();
        });
      });

      // Mettre à jour le tableau du panier
      function updateCartTable() {
        const cartTableBody = document.querySelector("#cart-table tbody");
        cartTableBody.innerHTML = "";

        cart.forEach((item, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${item.produitNom}</td>
                    <td>${item.quantite}</td>
                    <td>${(item.quantite * item.prixUnitaire).toFixed(2)}€</td>
                    <td><button data-index="${index}" class="remove-product">Supprimer</button></td>
                `;
          cartTableBody.appendChild(row);
        });

        // Ajouter les événements pour supprimer un produit
        document.querySelectorAll(".remove-product").forEach((button) => {
          button.addEventListener("click", (event) => {
            const index = event.target.getAttribute("data-index");
            cart.splice(index, 1);
            updateCartTable();
          });
        });
      }

      // Soumettre la vente
      document.getElementById("submit-sale").addEventListener("click", () => {
        const clientId = document.getElementById("client").value;
        const produits = cart.map((item) => item.produitId);
        const quantites = cart.map((item) => item.quantite);
        const prixUnitaires = cart.map((item) => item.prixUnitaire);

        axios
          .post("/ajouter-vente/", {
            client_id: clientId,
            produits,
            quantites,
            prix_unitaires: prixUnitaires,
          })
          .then((response) => {
            if (response.data.success) {
              alert("Vente ajoutée avec succès !");
              location.reload();
            } else {
              alert("Erreur lors de l'ajout de la vente.");
            }
          });
      });
    </script>
  </body>
</html>
